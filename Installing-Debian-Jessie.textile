h2. Installing Debian "Jessie" 8.2

This guide is not to be a replacement of the official Debian Installer documentation, but instead be a quick walkthrough for the network installer. You can find the original documentation at "https://www.debian.org/releases/jessie/arm64/index.html.en":https://www.debian.org/releases/jessie/arm64/index.html.en

h3. Setting up the TFTP server

Back to your dnsmasq server (check "this link":https://github.com/96boards/documentation/wiki/DHCP-TFTP-server-for-UEFI-distro-network-installers for instructions on how to setup your own TFTP/DCHP server), download the required Debian installer files at your tftp-root directory. In this example, this directory is configured to @/srv/tftp@.

Since the kernel, initrd and GRUB 2 is part of the debian-installer tarball (@netboot.tar.gz@), that is the only file you will need to download and use.

h4. Debian Installer

The released debian-installer from Debian Jessie contains a kernel based on 3.16, which doesn't yet provide support for development boards used by the reference software project. For a complete enterprise experience (including support for tip-based kernel with ACPI support and additional platforms), we also build and publish a custom debian installer that incorporates a more recent kernel.

Our custom installer changes nothing more than the kernel, and you can also find the instructions to build it from source at the end of this document.

*Downloading debian-installer:*

bc. sudo su -
cd /srv/tftp/
wget https://builds.96boards.org/snapshots/reference-platform/components/debian-installer/latest/netboot.tar.gz
tar -zxvf netboot.tar.gz

You should now have the following file tree structure:

bc. /srv/tftp/
├── debian-installer
│   └── arm64
│       ├── bootnetaa64.efi
│       ├── grub
│       │   ├── arm64-efi
│       │   │   ├── acpi.mod
│       │   │   ├── adler32.mod
│       │   │   ├── all_video.mod
│       │   │   ├── archelp.mod
│       │   │   ├── bfs.mod
│       │   │   ├── bitmap.mod
│       │   │   ├── bitmap_scale.mod
│       │   │   ├── blocklist.mod
│       │   │   ├── boot.mod
│       │   │   ├── btrfs.mod
│       │   │   ├── bufio.mod
│       │   │   ├── cat.mod
│       │   │   ├── cbfs.mod
│       │   │   ├── chain.mod
│       │   │   ├── cmdline_cat_test.mod
│       │   │   ├── cmp.mod
│       │   │   ├── command.lst
│       │   │   ├── cpio_be.mod
│       │   │   ├── cpio.mod
│       │   │   ├── crc64.mod
│       │   │   ├── cryptodisk.mod
│       │   │   ├── crypto.lst
│       │   │   ├── crypto.mod
│       │   │   ├── datehook.mod
│       │   │   ├── date.mod
│       │   │   ├── datetime.mod
│       │   │   ├── diskfilter.mod
│       │   │   ├── disk.mod
│       │   │   ├── div_test.mod
│       │   │   ├── dm_nv.mod
│       │   │   ├── echo.mod
│       │   │   ├── efifwsetup.mod
│       │   │   ├── efi_gop.mod
│       │   │   ├── efinet.mod
│       │   │   ├── elf.mod
│       │   │   ├── eval.mod
│       │   │   ├── exfat.mod
│       │   │   ├── exfctest.mod
│       │   │   ├── ext2.mod
│       │   │   ├── extcmd.mod
│       │   │   ├── fat.mod
│       │   │   ├── file.mod
│       │   │   ├── font.mod
│       │   │   ├── fs.lst
│       │   │   ├── gcry_arcfour.mod
│       │   │   ├── gcry_blowfish.mod
│       │   │   ├── gcry_camellia.mod
│       │   │   ├── gcry_cast5.mod
│       │   │   ├── gcry_crc.mod
│       │   │   ├── gcry_des.mod
│       │   │   ├── gcry_dsa.mod
│       │   │   ├── gcry_idea.mod
│       │   │   ├── gcry_md4.mod
│       │   │   ├── gcry_md5.mod
│       │   │   ├── gcry_rfc2268.mod
│       │   │   ├── gcry_rijndael.mod
│       │   │   ├── gcry_rmd160.mod
│       │   │   ├── gcry_rsa.mod
│       │   │   ├── gcry_seed.mod
│       │   │   ├── gcry_serpent.mod
│       │   │   ├── gcry_sha1.mod
│       │   │   ├── gcry_sha256.mod
│       │   │   ├── gcry_sha512.mod
│       │   │   ├── gcry_tiger.mod
│       │   │   ├── gcry_twofish.mod
│       │   │   ├── gcry_whirlpool.mod
│       │   │   ├── geli.mod
│       │   │   ├── gettext.mod
│       │   │   ├── gfxmenu.mod
│       │   │   ├── gfxterm_background.mod
│       │   │   ├── gfxterm_menu.mod
│       │   │   ├── gfxterm.mod
│       │   │   ├── gptsync.mod
│       │   │   ├── grub.cfg
│       │   │   ├── gzio.mod
│       │   │   ├── halt.mod
│       │   │   ├── hashsum.mod
│       │   │   ├── help.mod
│       │   │   ├── hexdump.mod
│       │   │   ├── hfs.mod
│       │   │   ├── hfspluscomp.mod
│       │   │   ├── hfsplus.mod
│       │   │   ├── http.mod
│       │   │   ├── jfs.mod
│       │   │   ├── jpeg.mod
│       │   │   ├── keystatus.mod
│       │   │   ├── ldm.mod
│       │   │   ├── linux.mod
│       │   │   ├── loadenv.mod
│       │   │   ├── loopback.mod
│       │   │   ├── lsacpi.mod
│       │   │   ├── lsefimmap.mod
│       │   │   ├── lsefi.mod
│       │   │   ├── lsefisystab.mod
│       │   │   ├── lsmmap.mod
│       │   │   ├── ls.mod
│       │   │   ├── lssal.mod
│       │   │   ├── luks.mod
│       │   │   ├── lvm.mod
│       │   │   ├── lzopio.mod
│       │   │   ├── macbless.mod
│       │   │   ├── macho.mod
│       │   │   ├── mdraid09_be.mod
│       │   │   ├── mdraid09.mod
│       │   │   ├── mdraid1x.mod
│       │   │   ├── memrw.mod
│       │   │   ├── minicmd.mod
│       │   │   ├── minix2_be.mod
│       │   │   ├── minix2.mod
│       │   │   ├── minix3_be.mod
│       │   │   ├── minix3.mod
│       │   │   ├── minix_be.mod
│       │   │   ├── mmap.mod
│       │   │   ├── moddep.lst
│       │   │   ├── mpi.mod
│       │   │   ├── msdospart.mod
│       │   │   ├── net.mod
│       │   │   ├── newc.mod
│       │   │   ├── normal.mod
│       │   │   ├── ntfscomp.mod
│       │   │   ├── ntfs.mod
│       │   │   ├── odc.mod
│       │   │   ├── offsetio.mod
│       │   │   ├── part_acorn.mod
│       │   │   ├── part_amiga.mod
│       │   │   ├── part_apple.mod
│       │   │   ├── part_bsd.mod
│       │   │   ├── part_dfly.mod
│       │   │   ├── part_dvh.mod
│       │   │   ├── part_gpt.mod
│       │   │   ├── partmap.lst
│       │   │   ├── part_msdos.mod
│       │   │   ├── part_plan.mod
│       │   │   ├── part_sun.mod
│       │   │   ├── part_sunpc.mod
│       │   │   ├── parttool.lst
│       │   │   ├── parttool.mod
│       │   │   ├── password.mod
│       │   │   ├── password_pbkdf2.mod
│       │   │   ├── pbkdf2.mod
│       │   │   ├── pbkdf2_test.mod
│       │   │   ├── png.mod
│       │   │   ├── priority_queue.mod
│       │   │   ├── probe.mod
│       │   │   ├── procfs.mod
│       │   │   ├── progress.mod
│       │   │   ├── raid5rec.mod
│       │   │   ├── raid6rec.mod
│       │   │   ├── read.mod
│       │   │   ├── reboot.mod
│       │   │   ├── regexp.mod
│       │   │   ├── reiserfs.mod
│       │   │   ├── romfs.mod
│       │   │   ├── scsi.mod
│       │   │   ├── serial.mod
│       │   │   ├── setjmp.mod
│       │   │   ├── setjmp_test.mod
│       │   │   ├── signature_test.mod
│       │   │   ├── sleep.mod
│       │   │   ├── sleep_test.mod
│       │   │   ├── squash4.mod
│       │   │   ├── syslinuxcfg.mod
│       │   │   ├── terminal.lst
│       │   │   ├── terminal.mod
│       │   │   ├── terminfo.mod
│       │   │   ├── test_blockarg.mod
│       │   │   ├── testload.mod
│       │   │   ├── test.mod
│       │   │   ├── testspeed.mod
│       │   │   ├── tftp.mod
│       │   │   ├── tga.mod
│       │   │   ├── time.mod
│       │   │   ├── trig.mod
│       │   │   ├── tr.mod
│       │   │   ├── true.mod
│       │   │   ├── udf.mod
│       │   │   ├── ufs1_be.mod
│       │   │   ├── ufs1.mod
│       │   │   ├── ufs2.mod
│       │   │   ├── verify.mod
│       │   │   ├── video_colors.mod
│       │   │   ├── video_fb.mod
│       │   │   ├── videoinfo.mod
│       │   │   ├── video.lst
│       │   │   ├── video.mod
│       │   │   ├── videotest_checksum.mod
│       │   │   ├── videotest.mod
│       │   │   ├── xfs.mod
│       │   │   ├── xnu_uuid.mod
│       │   │   ├── xnu_uuid_test.mod
│       │   │   ├── xzio.mod
│       │   │   └── zfscrypt.mod
│       │   ├── font.pf2
│       │   └── grub.cfg
│       ├── initrd.gz
│       └── linux
├── netboot.tar.gz
└── version.info

Now just make sure that @/etc/dnsmasq.conf@ is pointing out to the right boot file, like:

bc. dhcp-boot=debian-installer/arm64/bootnetaa64.efi

h3. Booting the installer

Now boot your platform of choice, selecting PXE boot when presented by UEFI (make sure to boot with the right network interface, in case more than one is available).

You should see the following (using AMD Seattle's Overdrive as example):

bc. NOTICE:  BL3-1: 
NOTICE:  BL3-1: Built : 18:22:46, Nov 23 2015
INFO:    BL3-1: Initializing runtime services
INFO:    BL3-1: Preparing for EL3 exit to normal world
INFO:    BL3-1: Next image address = 0x8000000000
INFO:    BL3-1: Next image spsr = 0x3c9
Boot firmware (version  built at 18:27:24 on Nov 23 2015)
Version 2.17.1249. Copyright (C) 2015 American Megatrends, Inc.                 
BIOS Date: 11/23/2015 18:23:09 Ver: ROD0085E00                                  
Press <DEL> or <ESC> to enter setup.  
.
>>Checking Media Presence......
>>Media Present......
>>Start PXE over IPv4.
  Station IP address is 192.168.3.57
  Server IP address is 192.168.3.1
  NBP filename is BOOTAA64.EFI
  NBP filesize is 885736 Bytes
>>Checking Media Presence......
>>Media Present......
 Downloading NBP file...
 Succeed to download NBP file.
 Fetching Netboot Image

At this stage you should be able to see the Grub 2 menu, like:

bc. Install
Advanced options ...
Install with speech synthesis
.
Use the  and  keys to change the selection.                       
Press 'e' to edit the selected item, or 'c' for a command prompt.

Now just hit enter and wait for the kernel and initrd to load, which automatically loads the installer and provides you the installer console menu, so you can finally install Debian.

You should see the following:

bc. EFI stub: Booting Linux Kernel...
EFI stub: Using DTB from configuration table
EFI stub: Exiting boot services and installing virtual address map...
[    0.355175] ACPI: IORT: Failed to get table, AE_NOT_FOUND
[    0.763784] kvm [1]: error: no compatible GIC node found
[    0.763818] kvm [1]: error initializing Hyp mode: -19
[    0.886298] Failed to find cpu0 device node
[    0.947082] zswap: default zpool zbud not available
[    0.951959] zswap: pool creation failed
Starting system log daemon: syslogd, klogd.
...
  ┌───────────────────────┤ [!!] Select a language ├────────────────────────┐
  │                                                                         │
  │ Choose the language to be used for the installation process. The        │
  │ selected language will also be the default language for the installed   │
  │ system.                                                                 │
  │                                                                         │
  │ Language:                                                               │
  │                                                                         │
  │                               C                                         │
  │                               English                                   │
  │                                                                         │
  │     <Go Back>                                                           │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
<Tab> moves; <Space> selects; <Enter> activates buttons

h3. Finishing the installation

For using the installer, please check the documentation available at "https://www.debian.org/releases/jessie/arm64/ch06.html.en":https://www.debian.org/releases/jessie/arm64/ch06.html.en

Once the installation is completed, you should be able to simply reboot the system in order to boot your new Debian system.

h3. Automating the installation using preseeding

Preseeding provides a way to set answers to questions asked during the installation process, without having to manually enter the answers while the installation is running. This makes it possible to fully automate the installation over network, when used together with the debian-installer.

This document only provides a quick way for you to get started with preseeding. For the complete guide, please check the "Debian GNU/Linux Installation Guide":https://www.debian.org/releases/jessie/arm64/apb.html and "example-preseed.txt":https://www.debian.org/releases/jessie/example-preseed.txt

*Note:* Since we require an external kernel to be installed during the install process, this is done via the @preseed/late_command@ argument, so you if you decide to use that command as part of your preseed file, make sure to add the following as part of the multi-line command:

bc. d-i preseed/late_command string in-target apt-get install -y linux-image-4.4.0-trunk-arm64; # here you can add 'in-target foobar' for additional commands

h4. Creating the preseed file

Check "example-preseed.txt":https://www.debian.org/releases/jessie/example-preseed.txt for a wide list of options supported by the Debian Jessie installer. Your file needs to use a similar format, but customized for your own needs.

Once created, make sure the file gets published into a network address that can be reachable from your target device.

Preseed example (@preseed.cfg@):

bc. d-i debian-installer/locale string en_US
d-i keyboard-configuration/xkb-keymap select us
d-i netcfg/dhcp_timeout string 60
d-i netcfg/get_hostname string unassigned-hostname
d-i netcfg/get_domain string unassigned-domain
d-i netcfg/hostname string debian
d-i mirror/country string manual
d-i mirror/http/hostname string ftp.br.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i passwd/root-password password linaro123
d-i passwd/root-password-again password linaro123
d-i passwd/user-fullname string Linaro User
d-i passwd/username string linaro
d-i passwd/user-password password linaro
d-i passwd/user-password-again password linaro
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i partman-auto/disk string /dev/sda
d-i partman-auto/method string lvm
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true
d-i partman-auto/choose_recipe select home
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
tasksel tasksel/first multiselect standard, web-server
d-i pkgsel/upgrade select safe-upgrade
d-i finish-install/reboot_in_progress note

In this example, this content is also available at "http://people.linaro.org/~ricardo.salveti/preseed.cfg":http://people.linaro.org/~ricardo.salveti/preseed.cfg

h4. Setting up grub.cfg

Now back to your tftp server, change the original @grub.cfg@ file adding the location of your preseed file:

bc. $ cat /srv/tftp/debian-installer/arm64/grub/grub.cfg 
# Force grub to automatically load the first option
set default=0
set timeout=1
menuentry 'Install with preseeding' {
    linux    /debian-installer/arm64/linux auto=true priority=critical url=http://people.linaro.org/~ricardo.salveti/preseed.cfg ---
    initrd   /debian-installer/arm64/initrd.gz
}

The @auto@ kernel parameter is an alias for @auto-install/enable@ and setting it to @true@ delays the locale and keyboard questions until after there has been a chance to preseed them, while @priority@ is an alias for @debconf/priority@ and setting it to @critical@ stops any questions with a lower priority from being asked.

In case your system contains more than one network interface, also make sure to add the one to be used via the @interface@ argument, like @interface=eth1@.

h4. Booting the system

Now just do a normal PXE boot, and debian-installer should automatically load and use the preseeds file provided by @grub.cfg@. In case there is still a dialog that stops your installation that means not all the debian-installer options are provided by your preseeds file. Get back to "example-preseed.txt":https://www.debian.org/releases/jessie/example-preseed.txt and try to identify what is missing step.

Also make sure to check debian-installer's @/var/log/syslog@ (by opening a shell) when debugging the installer.

h3. Building debian-installer from source

h4. Build kernel package and udebs

Check the debian "kernel-handbook":http://kernel-handbook.alioth.debian.org/ch-common-tasks.html for the instructions required to build the debian kernel package from scratch. Since the installer only understands @udeb@ packages, it is a good idea to reuse the official kernel packaging instructions and rules.

You can also find the custom kernel source package created as part of the EE-RPB effort at "https://builds.96boards.org/snapshots/reference-platform/components/linux/enterprise/latest/":https://builds.96boards.org/snapshots/reference-platform/components/linux/enterprise/latest/

h4. Rebuilding debian-installer with the new udebs

bc. # Build the installer
sudo apt-get build-dep debian-installer
dget http://ftp.us.debian.org/debian/pool/main/d/debian-installer/debian-installer_20150422+deb8u2.dsc
cd debian-installer-*
# Config changes
cd build
sed -i "s/LINUX_KERNEL_ABI.*/LINUX_KERNEL_ABI = YOUR_KERNEL_ABI/g" config/common
sed -i "s/PRESEED.*/PRESEED = default-preseed/g" config/common
# Download udebs
cd localudebs
wget <list of your custom udeb files created by the kernel debian package>
cd ..
# Local pkg-list (include all udebs, as d-i will not be able to find them online)
cat <<EOF > pkg-lists/local
ext4-modules-\${kernel:Version}
fat-modules-\${kernel:Version}
btrfs-modules-\${kernel:Version}
md-modules-\${kernel:Version}
efi-modules-\${kernel:Version}
scsi-modules-\${kernel:Version}
jfs-modules-\${kernel:Version}
xfs-modules-\${kernel:Version}
ata-modules-\${kernel:Version}
sata-modules-\${kernel:Version}
usb-storage-modules-\${kernel:Version}
EOF
# Set up local repo
cat <<EOF > sources.list.udeb
deb [trusted=yes] copy:/PATH/TO/your/installer/d-i/debian-installer-20150422/build/ localudebs/
deb http://httpredir.debian.org/debian jessie main/debian-installer
EOF
# Default preseed to skip known errors (as the kernel provided by local udebs)
cat <<EOF > default-preseed
# Continue install on "no kernel modules were found for this kernel"
d-i anna/no_kernel_modules boolean true
# Continue install on "no installable kernels found"
d-i base-installer/kernel/skip-install boolean true
d-i base-installer/kernel/no-kernels-found boolean true
d-i preseed/late_command string in-target wget <your linux-image.deb>; dpkg -i linux-image-*.deb 
EOF
fakeroot make build_netboot

You should now find your custom debian-installer at @dest/netboot/netboot.tar.gz@.